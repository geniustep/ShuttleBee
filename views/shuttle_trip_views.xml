<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- List View -->
    <record id="view_shuttle_trip_list" model="ir.ui.view">
        <field name="name">shuttle.trip.list</field>
        <field name="model">shuttle.trip</field>
        <field name="arch" type="xml">
            <list string="Shuttle Trips"
                  decoration-info="state=='draft'"
                  decoration-primary="state=='planned'"
                  decoration-warning="state=='ongoing'"
                  decoration-success="state=='done'"
                  decoration-danger="state=='cancelled'"
                  sample="1">
                <field name="reference" optional="show"/>
                <field name="name"/>
                <field name="date"/>
                <field name="trip_type" widget="badge"/>
                <field name="driver_id" widget="many2one_avatar_user"/>
                <field name="planned_start_time" optional="hide"/>
                <field name="passenger_count"/>
                <field name="booked_seats"/>
                <field name="total_seats"/>
                <field name="occupancy_rate" widget="progressbar" optional="show"/>
                <field name="state" widget="badge"
                       decoration-info="state=='draft'"
                       decoration-primary="state=='planned'"
                       decoration-warning="state=='ongoing'"
                       decoration-success="state=='done'"
                       decoration-danger="state=='cancelled'"/>
                <field name="company_id" groups="base.group_multi_company" optional="hide"/>
            </list>
        </field>
    </record>

    <!-- Form View -->
    <record id="view_shuttle_trip_form" model="ir.ui.view">
        <field name="name">shuttle.trip.form</field>
        <field name="model">shuttle.trip</field>
        <field name="arch" type="xml">
            <form string="Shuttle Trip">
                <header>
                    <button name="action_confirm" string="Confirm Trip"
                            type="object" class="oe_highlight"
                            invisible="state != 'draft'"/>
                    <button name="action_start" string="Start Trip"
                            type="object" class="oe_highlight"
                            invisible="state != 'planned'"/>
                    <button name="action_complete" string="Complete Trip"
                            type="object" class="oe_highlight"
                            invisible="state != 'ongoing'"/>
                    <button name="action_cancel" string="Cancel"
                            type="object"
                            invisible="state in ['done', 'cancelled']"
                            confirm="Are you sure you want to cancel this trip?"/>
                    <button name="action_reset_to_draft" string="Reset to Draft"
                            type="object"
                            invisible="state not in ['cancelled']"/>
                    <field name="state" widget="statusbar"
                           statusbar_visible="draft,planned,ongoing,done"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_notifications"
                                type="object"
                                class="oe_stat_button"
                                icon="fa-bell">
                            <div class="o_stat_info">
                                <span class="o_stat_text">Notifications</span>
                            </div>
                        </button>
                    </div>
                    <widget name="web_ribbon" title="Cancelled"
                            bg_color="text-bg-danger"
                            invisible="state != 'cancelled'"/>
                    <widget name="web_ribbon" title="Done"
                            bg_color="text-bg-success"
                            invisible="state != 'done'"/>

                    <div class="oe_title">
                        <label for="name"/>
                        <h1>
                            <field name="name" placeholder="e.g., Morning Route A"/>
                        </h1>
                        <group>
                            <field name="reference" readonly="1"/>
                        </group>
                    </div>

                    <group>
                        <group name="trip_info" string="Trip Information">
                            <field name="trip_type" widget="radio"/>
                            <field name="date"/>
                            <field name="group_id"
                                   options="{'no_create': True}"
                                   context="{'default_trip_type': trip_type}"
                                   required="1"/>
                            <field name="driver_id"
                                   options="{'no_create': True, 'no_open': True}"/>
                            <field name="vehicle_id"
                                   options="{'no_create': True}"/>
                        </group>
                        <group name="schedule" string="Schedule">
                            <field name="planned_start_time"
                                   widget="datetime"/>
                            <field name="planned_arrival_time"
                                   widget="datetime"/>
                            <field name="actual_start_time"
                                   widget="datetime"
                                   readonly="1"/>
                            <field name="actual_arrival_time"
                                   widget="datetime"
                                   readonly="1"/>
                            <field name="duration" widget="float_time" readonly="1"/>
                        </group>
                    </group>

                    <group>
                        <group name="capacity" string="Capacity">
                            <field name="total_seats"/>
                            <field name="booked_seats" readonly="1"/>
                            <field name="available_seats" readonly="1"/>
                            <field name="occupancy_rate" widget="progressbar" readonly="1"/>
                        </group>
                        <group name="statistics" string="Passenger Statistics">
                            <field name="passenger_count" readonly="1"/>
                            <field name="present_count" readonly="1"/>
                            <field name="absent_count" readonly="1"/>
                            <field name="boarded_count" readonly="1"/>
                        </group>
                    </group>

                    <notebook>
                        <page string="Passengers" name="passengers">
                            <field name="line_ids"
                                   widget="one2many"
                                   mode="list,kanban"
                                   context="{'default_trip_id': id, 'default_trip_type': trip_type, 'default_group_id': group_id}">
                                <list string="Passengers" editable="bottom">
                                    <field name="sequence" widget="handle"/>
                                    <field name="passenger_id"
                                           options="{'no_create': True}"/>
                                    <field name="pickup_stop_id"/>
                                    <field name="pickup_latitude"
                                           invisible="pickup_stop_id"
                                           optional="hide"/>
                                    <field name="pickup_longitude"
                                           invisible="pickup_stop_id"
                                           optional="hide"/>
                                    <field name="dropoff_stop_id"
                                           optional="hide"/>
                                    <field name="dropoff_latitude"
                                           invisible="dropoff_stop_id"
                                           optional="hide"/>
                                    <field name="dropoff_longitude"
                                           invisible="dropoff_stop_id"
                                           optional="hide"/>
                                    <field name="seat_count"/>
                                    <field name="status" widget="badge"/>
                                    <button name="action_send_approaching_notification"
                                            type="object"
                                            icon="fa-paper-plane"
                                            title="Send Approaching Notification"
                                            invisible="status != 'planned'"/>
                                    <button name="action_send_arrived_notification"
                                            type="object"
                                            icon="fa-map-marker"
                                            title="Send Arrived Notification"
                                            invisible="status not in ['planned', 'notified_approaching']"/>
                                    <button name="action_mark_boarded"
                                            type="object"
                                            icon="fa-check-circle text-success"
                                            title="Mark Boarded"
                                            invisible="status in ['boarded', 'absent', 'dropped']"/>
                                    <button name="action_mark_absent"
                                            type="object"
                                            icon="fa-times-circle text-danger"
                                            title="Mark Absent"
                                            invisible="status in ['absent', 'dropped']"/>
                                    <button name="action_reset_to_planned"
                                            type="object"
                                            icon="fa-undo text-info"
                                            title="Reset to Planned"
                                            invisible="status == 'planned'"/>
                                </list>
                                <kanban>
                                    <field name="passenger_id"/>
                                    <field name="status"/>
                                    <field name="pickup_stop_id"/>
                                    <templates>
                                        <t t-name="kanban-box">
                                            <div class="oe_kanban_global_click">
                                                <div class="o_kanban_record_top">
                                                    <strong><field name="passenger_id"/></strong>
                                                    <field name="status" widget="label"/>
                                                </div>
                                                <div class="o_kanban_record_body">
                                                    <field name="pickup_stop_id"/>
                                                </div>
                                            </div>
                                        </t>
                                    </templates>
                                </kanban>
                            </field>
                        </page>

                        <page string="Stops" name="stops">
                            <field name="stop_ids" widget="many2many_tags"/>
                        </page>

                        <page string="Notes" name="notes">
                            <field name="notes" placeholder="Additional notes about this trip..."/>
                        </page>
                    </notebook>
                </sheet>
                <chatter/>
            </form>
        </field>
    </record>

    <!-- Kanban View -->
    <record id="view_shuttle_trip_kanban" model="ir.ui.view">
        <field name="name">shuttle.trip.kanban</field>
        <field name="model">shuttle.trip</field>
        <field name="arch" type="xml">
            <kanban default_group_by="state"
                    class="o_kanban_small_column"
                    sample="1">
                <field name="name"/>
                <field name="reference"/>
                <field name="date"/>
                <field name="driver_id"/>
                <field name="passenger_count"/>
                <field name="state"/>
                <field name="color"/>
                <templates>
                    <t t-name="kanban-box">
                        <div t-attf-class="{{!selection_mode ? 'oe_kanban_color_' + kanban_getcolor(record.color.raw_value) : ''}} oe_kanban_card oe_kanban_global_click">
                            <div class="o_kanban_record_top mb-2">
                                <strong class="o_kanban_record_title">
                                    <field name="reference"/> - <field name="name"/>
                                </strong>
                                <div class="o_kanban_record_headings mt-1">
                                    <field name="date" widget="date"/>
                                </div>
                            </div>
                            <div class="o_kanban_record_body">
                                <div>
                                    <i class="fa fa-user"/> <field name="driver_id"/>
                                </div>
                                <div>
                                    <i class="fa fa-users"/>
                                    <t t-esc="record.passenger_count.value"/> Passengers
                                </div>
                            </div>
                            <div class="o_kanban_record_bottom mt-2">
                                <div class="oe_kanban_bottom_left">
                                    <field name="activity_ids" widget="kanban_activity"/>
                                </div>
                                <div class="oe_kanban_bottom_right">
                                    <field name="state" widget="label"/>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Calendar View -->
    <record id="view_shuttle_trip_calendar" model="ir.ui.view">
        <field name="name">shuttle.trip.calendar</field>
        <field name="model">shuttle.trip</field>
        <field name="arch" type="xml">
            <calendar string="Shuttle Trips Calendar"
                      date_start="planned_start_time"
                      date_stop="planned_arrival_time"
                      color="driver_id"
                      mode="month"
                      event_open_popup="true"
                      quick_create="false">
                <field name="name"/>
                <field name="driver_id"
                       filters="1"
                       avatar_field="avatar_128"/>
                <field name="state"
                       filters="1"
                       invisible="1"/>
            </calendar>
        </field>
    </record>

    <!-- Search View -->
    <record id="view_shuttle_trip_search" model="ir.ui.view">
        <field name="name">shuttle.trip.search</field>
        <field name="model">shuttle.trip</field>
        <field name="arch" type="xml">
            <search string="Search Trips">
                <field name="name"
                       filter_domain="['|', ('name', 'ilike', self), ('reference', 'ilike', self)]"/>
                <field name="driver_id"/>
                <field name="date"/>
                <separator/>
                <filter string="Today" name="today"
                        domain="[('date', '=', context_today())]"/>
                <filter string="This Month" name="this_month"
                        domain="[('date', '&gt;=', (context_today().replace(day=1)).strftime('%Y-%m-%d'))]"/>
                <separator/>
                <filter string="Draft" name="draft" domain="[('state', '=', 'draft')]"/>
                <filter string="Planned" name="planned" domain="[('state', '=', 'planned')]"/>
                <filter string="Ongoing" name="ongoing" domain="[('state', '=', 'ongoing')]"/>
                <filter string="Done" name="done" domain="[('state', '=', 'done')]"/>
                <separator/>
                <filter string="Pickup" name="pickup" domain="[('trip_type', '=', 'pickup')]"/>
                <filter string="Dropoff" name="dropoff" domain="[('trip_type', '=', 'dropoff')]"/>
                <separator/>
                <filter string="My Trips" name="my_trips"
                        domain="[('driver_id', '=', uid)]"/>
                <separator/>
                <filter string="Archived" name="inactive"
                        domain="[('active', '=', False)]"/>
                <group expand="0" string="Group By">
                    <filter string="Driver" name="group_driver"
                            context="{'group_by': 'driver_id'}"/>
                    <filter string="Date" name="group_date"
                            context="{'group_by': 'date'}"/>
                    <filter string="Trip Type" name="group_type"
                            context="{'group_by': 'trip_type'}"/>
                    <filter string="Status" name="group_status"
                            context="{'group_by': 'state'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Action -->
    <record id="action_shuttle_trip" model="ir.actions.act_window">
        <field name="name">Shuttle Trips</field>
        <field name="res_model">shuttle.trip</field>
        <field name="view_mode">list,kanban,form,calendar</field>
        <field name="context">{'search_default_today': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first shuttle trip!
            </p>
            <p>
                Plan and manage your shuttle transportation efficiently.
            </p>
        </field>
    </record>
</odoo>
