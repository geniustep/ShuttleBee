<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Passenger Group Tree -->
    <record id="view_shuttle_group_tree" model="ir.ui.view">
        <field name="name">shuttle.passenger.group.tree</field>
        <field name="model">shuttle.passenger.group</field>
        <field name="type">list</field>
        <field name="arch" type="xml">
            <list string="Passenger Groups" sample="1" decoration-muted="not active">
                <field name="name"/>
                <field name="trip_type" widget="badge"/>
                <field name="driver_id"/>
                <field name="companion_id"/>
                <field name="vehicle_id"/>
                <field name="member_count"/>
                <field name="total_seats"/>
                <field name="active"/>
            </list>
        </field>
    </record>

    <!-- Passenger Group Form -->
    <record id="view_shuttle_group_form" model="ir.ui.view">
        <field name="name">shuttle.passenger.group.form</field>
        <field name="model">shuttle.passenger.group</field>
        <field name="arch" type="xml">
            <form string="Passenger Group">
                <header>
                    <button name="action_optimize_route"
                            type="object"
                            class="btn-secondary"
                            string="üó∫Ô∏è Optimize Route"
                            confirm="This will reorder passengers based on the optimal route. Continue?"/>
                    <button name="action_open_generate_trip_wizard"
                            type="object"
                            class="oe_highlight"
                            string="Generate Trip"/>
                    <button name="action_open_schedule_generate_wizard"
                            type="object"
                            class="btn-secondary"
                            string="Generate Schedule Trips"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_open_related_trips"
                                type="object"
                                class="oe_stat_button"
                                icon="fa-bus">
                            <div class="o_stat_info">
                                <span class="o_stat_text">Trips</span>
                            </div>
                        </button>
                    </div>
                    <div class="oe_title">
                        <label for="name"/>
                        <h1>
                            <field name="name"/>
                        </h1>
                        <field name="code" class="oe_inline"/>
                    </div>
                    <group>
                        <group string="Route Details">
                            <field name="trip_type"/>
                            <field name="use_company_destination"/>
                            <field name="destination_latitude"
                                   readonly="use_company_destination"
                                   invisible="not use_company_destination"
                                   help="Latitude used as destination when no specific stop is provided."/>
                            <field name="destination_longitude"
                                   readonly="use_company_destination"
                                   invisible="not use_company_destination"
                                   help="Longitude used as destination when no specific stop is provided."/>
                            <field name="destination_stop_id"
                                   invisible="use_company_destination"
                                   required="not use_company_destination"
                                   help="Common destination (e.g., School, Office). Will be used automatically for passengers without a specific stop."/>
                            <field name="vehicle_id"/>
                            <field name="driver_id"/>
                            <field name="companion_id"/>
                            <field name="total_seats"/>
                        </group>
                        <group string="Additional Information">
                            <field name="member_count" readonly="1"/>
                            <field name="color"/>
                            <field name="company_id" groups="base.group_multi_company"/>
                            <field name="active"/>
                        </group>
                        <group string="Dispatcher Access" groups="shuttlebee.group_shuttle_manager">
                            <field name="dispatcher_id" readonly="1"/>
                            <field name="dispatcher_group_ids" widget="many2many_tags" options="{'no_create': True}"/>
                        </group>
                    </group>
                    <group>
                        <field name="notes" placeholder="Notes or requirements for this passenger group..."/>
                    </group>
                    <notebook>
                        <page string="Passengers">
                            <field name="line_ids" context="{'default_group_id': id}" mode="list,form" editable="bottom">
                                <list string="Passengers" editable="bottom">
                                    <field name="sequence" widget="handle"/>
                                    <field name="sequence" string="#" readonly="1" width="40px" optional="show"/>
                                    <field name="passenger_id"/>
                                    <field name="pickup_info_display" readonly="1"/>
                                    <field name="pickup_stop_id" string="Pickup Stop"/>
                                    <field name="dropoff_info_display" readonly="1"/>
                                    <field name="dropoff_stop_id" string="Dropoff Stop"/>
                                    <field name="seat_count"/>
                                    <field name="notes"/>
                                </list>
                                <form string="Passenger Line">
                                    <sheet>
                                        <group>
                                            <group>
                                                <field name="passenger_id"/>
                                                <field name="seat_count"/>
                                            </group>
                                            <group>
                                                <field name="pickup_info_display" readonly="1"/>
                                                <field name="pickup_stop_id">
                                                    <button name="action_suggest_nearest_stop" 
                                                            type="object" 
                                                            string="Suggest Nearest"
                                                            context="{'stop_type': 'pickup'}"
                                                            icon="fa-map-marker"
                                                            title="Suggest nearest pickup stop based on passenger GPS coordinates"
                                                            invisible="not passenger_id or not passenger_id.shuttle_latitude"/>
                                                </field>
                                                <field name="dropoff_stop_id">
                                                    <button name="action_suggest_nearest_stop" 
                                                            type="object" 
                                                            string="Suggest Nearest"
                                                            context="{'stop_type': 'dropoff'}"
                                                            icon="fa-map-marker"
                                                            title="Suggest nearest dropoff stop based on passenger GPS coordinates"
                                                            invisible="not passenger_id or not passenger_id.shuttle_latitude"/>
                                                </field>
                                                <field name="dropoff_info_display" readonly="1"/>
                                            </group>
                                        </group>
                                        <group>
                                            <field name="notes" placeholder="Notes / Requirements..."/>
                                        </group>
                                    </sheet>
                                </form>
                            </field>
                        </page>
                        <page string="Schedule">
                            <group>
                                <group>
                                    <!-- <field name="schedule_timezone"
                                           placeholder="Africa/Casablanca"
                                           help="Timezone used to interpret pickup/dropoff times for this group"/> -->
                                </group>
                                <field name="schedule_ids" context="{'default_group_id': id}" mode="list,form" nolabel="1">
                                    <list string="Weekly Schedule">
                                        <field name="weekday"/>
                                        <field name="pickup_time_display" string="Pickup Time"/>
                                        <field name="create_pickup"/>
                                        <field name="dropoff_time_display" string="Dropoff Time"/>
                                        <field name="create_dropoff"/>
                                        <field name="active"/>
                                    </list>
                                    <form string="Schedule Line">
                                        <sheet>
                                            <group>
                                                <field name="weekday"/>
                                                <field name="active"/>
                                            </group>
                                            <group string="Pickup">
                                                <field name="create_pickup"/>
                                                <field name="pickup_time" widget="datetime" options="{'datepicker': False}"/>
                                            </group>
                                            <group string="Dropoff">
                                                <field name="create_dropoff"/>
                                                <field name="dropoff_time" widget="datetime" options="{'datepicker': False}"/>
                                            </group>
                                        </sheet>
                                    </form>
                                </field>
                            </group>
                        </page>
                        <page string="Holidays / Exceptions">
                            <group>
                                <field name="holiday_ids" context="{'default_group_id': id}" mode="list,form" nolabel="1">
                                    <list editable="bottom" string="Holidays">
                                        <field name="name"/>
                                        <field name="start_date"/>
                                        <field name="end_date"/>
                                        <field name="active"/>
                                        <field name="notes"/>
                                    </list>
                                    <form string="Holiday">
                                        <sheet>
                                            <group>
                                                <field name="name"/>
                                                <field name="active"/>
                                            </group>
                                            <group>
                                                <field name="start_date"/>
                                                <field name="end_date"/>
                                            </group>
                                            <group>
                                                <field name="notes" nolabel="1"/>
                                            </group>
                                        </sheet>
                                    </form>
                                </field>
                            </group>
                        </page>
                        <page string="Automation">
                            <group>
                                <group>
                                    <field name="auto_schedule_enabled"/>
                                    <field name="auto_schedule_weeks"/>
                                </group>
                                <group>
                                    <field name="auto_schedule_include_pickup"/>
                                    <field name="auto_schedule_include_dropoff"/>
                                </group>
                            </group>
                            <div class="o_form_label">
                                <span>A cron runs every Saturday at 08:00 to generate the schedule for next week for enabled groups.</span>
                            </div>
                        </page>
                        <page string="üó∫Ô∏è Route Optimization" name="optimization">
                            <group>
                                <group string="Optimization Status">
                                    <field name="optimization_status" widget="badge"
                                           decoration-success="optimization_status == 'optimized'"
                                           decoration-danger="optimization_status == 'failed'"
                                           decoration-muted="optimization_status == 'not_optimized'"/>
                                    <field name="last_optimization_date" readonly="1"/>
                                </group>
                            </group>
                            
                            <!-- Before/After Comparison -->
                            <group invisible="optimization_status != 'optimized'">
                                <group string="‚ùå ŸÇÿ®ŸÑ ÿßŸÑÿ™ÿ≠ÿ≥ŸäŸÜ (BEFORE)">
                                    <field name="original_distance_km" string="ÿßŸÑŸÖÿ≥ÿßŸÅÿ© ÿßŸÑÿ£ÿµŸÑŸäÿ© (km)" readonly="1"/>
                                    <field name="original_duration_min" string="ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿ£ÿµŸÑŸä (min)" readonly="1"/>
                                </group>
                                <group string="‚úÖ ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ÿ≥ŸäŸÜ (AFTER)">
                                    <field name="optimized_distance_km" string="ÿßŸÑŸÖÿ≥ÿßŸÅÿ© ÿßŸÑŸÖÿ≠ÿ≥ŸëŸÜÿ© (km)" readonly="1"/>
                                    <field name="optimized_duration_min" string="ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖÿ≠ÿ≥ŸëŸÜ (min)" readonly="1"/>
                                </group>
                            </group>
                            
                            <!-- Savings -->
                            <group string="üí∞ ÿßŸÑÿ™ŸàŸÅŸäÿ± (SAVINGS)" invisible="optimization_status != 'optimized'">
                                <group>
                                    <field name="distance_saved_km" string="ÿßŸÑŸÖÿ≥ÿßŸÅÿ© ÿßŸÑŸÖŸàŸÅŸëÿ±ÿ© (km)" readonly="1"/>
                                    <field name="distance_saved_percent" string="ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿ™ŸàŸÅŸäÿ± (%)" readonly="1"/>
                                </group>
                                <group>
                                    <field name="time_saved_min" string="ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖŸàŸÅŸëÿ± (min)" readonly="1"/>
                                </group>
                            </group>
                            
                            <group string="Optimization Message" invisible="not optimization_message">
                                <field name="optimization_message" readonly="1" nolabel="1"/>
                            </group>
                            
                            <group invisible="optimization_status == 'optimized'">
                                <div class="alert alert-info" role="alert">
                                    <strong>‚ÑπÔ∏è Route Optimization</strong><br/>
                                    Optimizing the passenger order will reorder passengers based on the shortest route.
                                    This affects the template and all future trips generated from this group.
                                    <br/><br/>
                                    <strong>Requirements:</strong><br/>
                                    ‚Ä¢ Vehicle parking coordinates OR company GPS coordinates<br/>
                                    ‚Ä¢ Passengers with GPS coordinates (via Stop or directly)<br/>
                                    ‚Ä¢ Optionally set a Destination Stop
                                </div>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <chatter/>
            </form>
        </field>
    </record>

    <!-- Action -->
    <record id="action_shuttle_passenger_group" model="ir.actions.act_window">
        <field name="name">Passenger Groups</field>
        <field name="res_model">shuttle.passenger.group</field>
        <field name="view_mode">list,form</field>
        <field name="context">{'default_trip_type': 'both'}</field>
    </record>

    <!-- Global Shuttle Holidays (Standalone) -->
    <record id="view_shuttle_holiday_tree" model="ir.ui.view">
        <field name="name">shuttle.holiday.tree</field>
        <field name="model">shuttle.holiday</field>
        <field name="arch" type="xml">
            <list string="Holidays" decoration-muted="not active">
                <field name="name"/>
                <field name="start_date"/>
                <field name="end_date"/>
                <field name="active"/>
                <field name="company_id" groups="base.group_multi_company"/>
            </list>
        </field>
    </record>

    <record id="view_shuttle_holiday_form" model="ir.ui.view">
        <field name="name">shuttle.holiday.form</field>
        <field name="model">shuttle.holiday</field>
        <field name="arch" type="xml">
            <form string="Holiday">
                <sheet>
                    <group>
                        <field name="name"/>
                        <field name="active"/>
                    </group>
                    <group>
                        <field name="company_id" groups="base.group_multi_company"/>
                    </group>
                    <group>
                        <field name="start_date"/>
                        <field name="end_date"/>
                    </group>
                    <group>
                        <field name="notes" nolabel="1"/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <record id="action_shuttle_holiday" model="ir.actions.act_window">
        <field name="name">Holidays</field>
        <field name="res_model">shuttle.holiday</field>
        <field name="view_mode">list,form</field>
    </record>

    <!-- Passenger Group Holidays / Exceptions (Standalone) -->
    <record id="view_shuttle_passenger_group_holiday_tree" model="ir.ui.view">
        <field name="name">shuttle.passenger.group.holiday.tree</field>
        <field name="model">shuttle.passenger.group.holiday</field>
        <field name="arch" type="xml">
            <list string="Holidays / Exceptions" decoration-muted="not active">
                <field name="name"/>
                <field name="group_id"/>
                <field name="start_date"/>
                <field name="end_date"/>
                <field name="active"/>
                <field name="company_id" groups="base.group_multi_company"/>
            </list>
        </field>
    </record>

    <record id="view_shuttle_passenger_group_holiday_form" model="ir.ui.view">
        <field name="name">shuttle.passenger.group.holiday.form</field>
        <field name="model">shuttle.passenger.group.holiday</field>
        <field name="arch" type="xml">
            <form string="Holiday / Exception">
                <sheet>
                    <group>
                        <field name="name"/>
                        <field name="active"/>
                    </group>
                    <group>
                        <field name="group_id" required="1"/>
                        <field name="company_id" readonly="1" groups="base.group_multi_company"/>
                    </group>
                    <group>
                        <field name="start_date"/>
                        <field name="end_date"/>
                    </group>
                    <group>
                        <field name="notes" nolabel="1"/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <record id="action_shuttle_passenger_group_holiday" model="ir.actions.act_window">
        <field name="name">Holidays / Exceptions</field>
        <field name="res_model">shuttle.passenger.group.holiday</field>
        <field name="view_mode">list,form</field>
    </record>

</odoo>

